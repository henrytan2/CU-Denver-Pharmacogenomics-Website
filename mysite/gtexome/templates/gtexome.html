{% extends 'base.html' %}

{% block content %}
    <body style="background:none">
    <h1 style="margin-left: 10px">GTExome</h1>
    <button class="btn btn-secondary"
            data-toggle="modal"
            data-target="#directionsModal" style="margin:10px;text-align: right;">
        Info
    </button>
    <div class="modal fade" id="directionsModal" tabindex="-1" role="dialog" aria-labelledby="directionsModal"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="directionsModalTitle">Info</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    GTExome is a tool to connect genotype expression data to exome data by filtering the
                    <a href="https://gtexportal.org/home/">GTEx database</a> for specific TPM ranges in different
                    tissue types to get a list of genes. From the list of genes, you can view the exome data
                    sourced from <a href="https://gnomad.broadinstitute.org">gnomAD/ExAC</a>.<br>
                    <b>Directions:</b><br>
                    1. Select 'Filter By TPM Ratio' or 'Filter By TPM Range'.<br>
                    2. Add tissue types from the left list by clicking the plus button.<br>
                    &emsp;a. If 'Filter By TPM Ratio' is selected. Choose a ratio range to filter by or leave blank for
                    unbounded lower/upper range.<br>
                    &emsp;Ratio calculated by summing the TPM of selected tissues as the numerator and the sum of
                    non-selected tissues as the denominator.<br>
                    &emsp;b. If 'Filter By TPM Range' is selected. For each selected tissue, enter a range for median
                    TPM.<br>
                    4. Hit the Submit button once you are done.<br>
                    5. You will be redirected to a results page with a list of genes available in csv format.<br>
                    6. Each Gene ID is a link to exome data available in csv format.<br>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <index></index>
    <script id="index-template"
            type="x-html-template">
        <div id="table-wrapper">
            <ul class="nav nav-tabs"
                v-on:click="changeTabs">
                <li class="nav-item">
                    <a class="nav-link"
                       v-bind:class="{active: gtexTabIsActive}"
                       ref="gtexTab"
                       href="#">
                        gtex
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link"
                       v-bind:class="{active: exacTabIsActive}"
                       ref="exacTab"
                       href="#">
                        exac
                    </a>
                </li>
            </ul>
            <div v-show="gtexTabIsActive">
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-body" style="height:100vh; overflow-y: auto;">
                                <div class="form-inline" style="margin-bottom: 10px; margin-left: 10px;">
                                    <div id="filter-toggle"
                                         class="btn-group btn-group-toggle"
                                         data-toggle="buttons">
                                        <label class="btn btn-info active">
                                            <input type="radio"
                                                   name="options"
                                                   v-on:click="toggleFilter"
                                                   id="filter-by-ratio"
                                                   autocomplete="off"
                                                   checked>
                                            Filter By TPM Ratio
                                        </label>
                                        <label class="btn btn-info">
                                            <input type="radio"
                                                   v-on:click="toggleFilter"
                                                   name="options"
                                                   id="filter-by-range"
                                                   autocomplete="off">
                                            Filter By TPM Range
                                        </label>
                                    </div>
                                    <div v-if="filterByRatio"
                                         class="form-inline"
                                         id="filter-ratio-input"
                                         style="margin-left: 10px;">
                                        Ratio Range (Leave blank for unbounded lower/upper):
                                        <label>
                                            <input type="number"
                                                   v-model.number="lowerRatio"
                                                   style="margin-right: 10px"> â‰¤
                                        </label>
                                        <label>
                                            <input type="number"
                                                   v-model.number="upperRatio"
                                                   style="margin-left:10px">
                                        </label>
                                    </div>
                                </div>
                                <h3>Tissue types:</h3>
                                <ul id="tissue-list" class="list-group" style="overflow-y: scroll">
                                    <li class="list-group-item"
                                        v-for="field in allFieldNames">
                                        <span v-text="field"></span>
                                        <button class="btn btn-outline-secondary tissue-buttons float-right"
                                                style="min-width: 40px;"
                                                v-on:click="addOrRemoveTissue(field)">
                                                <span v-if="!selectedTissuesRatio.includes(field) && selectedTissuesRange.findIndex(t => t.tissueName === field) == -1"
                                                      key="doesNotIncludeTissue">
                                                    <i class="fas fa-plus"></i>
                                                </span>
                                            <span v-else key="includesTissue">
                                                    <i class="fas fa-times"></i>
                                                </span>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card">
                            <div class="card-body" style="height:100vh; overflow-y: auto;">
                                <h3>Selected Tissues: </h3>
                                <ul id="filter-list" class="list-group" style="overflow-y: scroll">
                                    <li v-for="(tissue, index) in selectedTissuesRatio">
                                        <span class="list-group-item">
                                            <span v-text="tissue"></span>
                                        </span>
                                    </li>
                                    <li v-for="(tissue, index) in selectedTissuesRange">
                                        <span class="list-group-item form-inline row">
                                            <span v-text="tissue.tissue"></span>
                                            <span class="float-right">
                                                <input class="lower" type="number"
                                                       v-model.number="tissue.range.lower"> to
                                                <input class="upper" type="number"
                                                       v-model.number="tissue.range.upper">
                                            </span>
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 10px">
                            <button type="submit"
                                    id="side-effect-list-submit"
                                    v-bind:disabled="submitButtonDisabled"
                                    v-on:click="viewResults"
                                    class="btn btn-primary submit-btn">
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div v-show="exacTabIsActive">
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <p>
                            <form>
                                <div class="form-group">
                                    <label for="exampleGene">Gene</label>
                                    <input type="text"
                                           placeholder="Search by gene name"
                                           v-model="exacInput">
                                    <small class="form-text text-muted">must be valid gnomad v2.1
                                        (https://gnomad.broadinstitute.org/) name.
                                    </small>
                                </div>
                            </form>
                            <div style="text-align: right; margin-top: 10px">
                                <button type="submit"
                                        id="side-effect-list-submit"
                                        v-bind:disabled="exacSubmitButtonDisabled"
                                        v-on:click="viewExacResults"
                                        class="btn btn-primary submit-btn">
                                    Submit to Exac
                                </button>
                            </div>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>

    </body>

    <script type="application/javascript">
        Vue.component("index", {
                data: function () {
                    let allFieldNames = {{ all_field_names | safe }};
                    return {
                        gtexTabIsActive: true,
                        exacTabIsActive: false,
                        lowerRatio: null,
                        upperRatio: null,
                        filterList: [],
                        allFieldNames: allFieldNames,
                        selectedTissuesRatio: [],
                        selectedTissuesRange: [],
                        filterByRatio: true,
                        exacInput: null,
                    }
                },
                template: "#index-template",
                computed: {
                    submitButtonDisabled: function () {
                        var response = true;
                        var selectedTissuesRatio = this.selectedTissuesRatio;
                        var selectedTissuesRange = this.selectedTissuesRange;
                        var selectedRatioLength = selectedTissuesRatio.length;
                        var selectedRangeLength = selectedTissuesRange.length;
                        if (!(selectedRatioLength > 0) || !(selectedRangeLength > 0)) {
                            if (this.filterByRatio) {
                                if (this.upperRatio > this.lowerRatio) {
                                    response = false;
                                }
                            } else {
                                response = false;
                            }
                        }
                        return response;
                    },
                    exacSubmitButtonDisabled: function () {
                        var input = 'exacInput'
                        if (input.length > 0) {
                            enabled = "exacSubmitButtonDisabled";
                        }

                    }
                },
                methods: {
                    addOrRemoveTissue: function (tissue) {
                        if (this.filterByRatio) {
                            if (false === this.selectedTissuesRatio.includes(tissue)) {
                                this.selectedTissuesRatio.push(tissue);
                            } else {
                                const index = this.selectedTissuesRatio.indexOf(tissue);
                                this.selectedTissuesRatio.splice(index, 1);
                            }
                        } else {
                            var tissueIndex = this.selectedTissuesRange.findIndex(t => t.tissueName === tissue);
                            if (tissueIndex === -1) {
                                var newTissue = {
                                    tissue: tissue,
                                    range: {
                                        lower: null,
                                        upper: null,
                                    }
                                };
                                this.selectedTissuesRange.push(newTissue);
                            } else {
                                this.selectedTissuesRange.splice(tissueIndex, 1);
                            }
                        }
                    },
                    changeTabs: function () {
                        if (this.gtexTabIsActive) {
                            this.gtexTabIsActive = false;
                            this.exacTabIsActive = true;
                        } else {
                            this.gtexTabIsActive = true;
                            this.exacTabIsActive = false;
                        }
                    },
                    toggleFilter: function () {
                        if (this.filterByRatio) {
                            this.selectedTissuesRatio = [];
                            this.filterByRatio = false;
                        } else {
                            this.selectedTissuesRange = [];
                            this.filterByRatio = true;
                        }
                    },
                    viewResults: function () {
                        if (this.filterByRatio) {
                            let filterRatioDict = {};
                            let lowerFilterRatio = this.lowerRatio;
                            let upperFilterRatio = this.upperRatio;
                            let tissues = this.selectedTissuesRatio;

                            if (lowerFilterRatio === "") {
                                lowerFilterRatio = Number.NEGATIVE_INFINITY;
                            }
                            if (upperFilterRatio === "") {
                                upperFilterRatio = Infinity
                            }

                            filterRatioDict["lower"] = lowerFilterRatio;
                            filterRatioDict["upper"] = upperFilterRatio;

                            filterRatioDict["tissues"] = tissues;

                            $.ajax({
                                type: 'POST',
                                url: "{% url 'gtexome:gtexome' %}",
                                data: {'filterRatio': JSON.stringify(filterRatioDict)},
                                success: function () {
                                    window.location = "{% url 'gtexome:ratio_results' %}"
                                }
                            });
                        } else {
                            var filterDictionary = this.selectedTissuesRange;
                            $.ajax({
                                type: 'POST',
                                url: '{% url 'gtexome:gtexome' %}',
                                data: {'filterDictionary': JSON.stringify(filterDictionary)},
                                success: function () {
                                    window.location = "{% url 'gtexome:range_results' %}";
                                }
                            });
                        }
                    },
                    viewExacResults: function () {
                        window.location = `{% url 'gtexome:exac_results' %}?gene_symbol=${this.exacInput}`;
                    },
                    GetAllFilters: function () {
                        if (filterByRatio) {
                            let filterRatioDict = {};
                            let lowerFilterRatio = this.lowerRatio;
                            let upperFilterRatio = this.upperRatio;
                            let tissues = [];

                            if (lowerFilterRatio === "") {
                                lowerFilterRatio = Number.NEGATIVE_INFINITY;
                            }
                            if (upperFilterRatio === "") {
                                upperFilterRatio = Infinity
                            }

                            filterRatioDict["lower"] = lowerFilterRatio;
                            filterRatioDict["upper"] = upperFilterRatio;

                            filterRatioDict["tissues"] = tissues;

                            $.ajax({
                                type: 'POST',
                                url: "{% url 'gtexome:gtexome' %}",
                                data: {'filterRatio': JSON.stringify(filterRatioDict)},
                                success: function () {
                                    window.location = "{% url 'gtexome:ratio_results' %}"
                                }
                            });
                        } else {
                            var filterDictionary = this.selectedTissuesRange;
                            $.ajax({
                                type: 'POST',
                                url: '{% url 'gtexome:gtexome' %}',
                                data: {'filterDictionary': JSON.stringify(filterDictionary)},
                                success: function () {
                                    window.location = "{% url 'gtexome:range_results' %}";
                                }
                            });
                        }
                    },
                }
            }
        )
    </script>
{% endblock content %}